<html>
  <head>
    <title>Religious Diversity in NZ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.3.1/leaflet.css" integrity="sha256-iYUgmrapfDGvBrePJPrMWQZDcObdAcStKBpjP3Az+3s=" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.3.1/leaflet.js" integrity="sha256-CNm+7c26DTTCGRQkM9vp7aP85kHFMqs9MhPEuytF+fQ=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/2.1.0/leaflet.ajax.min.js" integrity="sha256-rVeyUZMfAHhQJ7hvWaHrKknTDdqGcn1gxBBJA++E4z8=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <style>
      html, body, #map {
        height: 100%;
        width: 100%;
        margin: 0;
        padding: 0;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <script>
      var map = L.map('map').setView([-41.235726,172.5118422], 6);
      L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png', {
	      attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',
	      subdomains: 'abcd',
	      maxZoom: 19,
	      minZoom: 6,
      }).addTo(map);
      var bounds = map.getBounds();
      bounds._northEast.lat += 10;
      bounds._northEast.lng += 10;
      bounds._southWest.lat -= 10;
      bounds._southWest.lng -= 10;
      map.setMaxBounds(bounds);
      
      function round(x, dp) {
        var factor = Math.pow(10, dp);
        var tmp = x * factor;
        tmp = Math.round(tmp);
        return tmp / factor;
      }
      
      function getPctForReligion(religion, yearData) {
        if (religion == "Christian") {
          return round((yearData.Christian + yearData.Maori_Christian) / yearData.Total_people_stated * 100, 1);
        } else {
          return round(yearData[religion] / yearData.Total_people_stated * 100, 1);
        }
      }
      
      function formatDataForYear(yearData) {
        if (yearData.Total_people_stated == null) {
          return "No data";
        }
        return "<div>Buddhist: " + getPctForReligion("Buddhist", yearData) +
               "%</div><div>Christian: " + getPctForReligion("Christian", yearData) +
               "%</div><div>Hindu: " + getPctForReligion("Hindu", yearData) +
               "%</div><div>Jewish: " + getPctForReligion("Judaism/_Jewish", yearData) +
               "%</div><div>Muslim: " + getPctForReligion("Islam/Muslim", yearData) +
               "%</div><div>No Religion: " + getPctForReligion("No_Religion", yearData) +
               "%</div><div>New Age: " + getPctForReligion("Spiritualism_and_New_Age_Religions", yearData) +
               "%</div><div>Total people stated: " + yearData.Total_people_stated;
      }
      
      function formatData(data) {
        return "<h2>" + data.desc + "</h2><h3>2001</h3>" + formatDataForYear(data[2001]) + "<h3>2006</h3>" + formatDataForYear(data[2006]) + "<h3>2013</h3>" + formatDataForYear(data[2013]);
      }
      
      $.getJSON("religion.json", function(data) {
        console.log(data);
        function onEachFeature(feature, layer) {
            var id = feature.properties.AU2013;
            layer.bindPopup(formatData(data[id]));
        }
        
        var geojsonLayer = new L.GeoJSON.AJAX("au.geojson", {
          style: function(feature) {
              var id = feature.properties.AU2013;
              
          },
          onEachFeature: onEachFeature
        }).addTo(map);
      });
    </script>
  </body>
</html>
